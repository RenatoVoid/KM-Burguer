<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>KM BURGER - Gerente PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #0f0f12; color: #e4e4e7; font-family: sans-serif; }
        .column-bg { background-color: #121214; border: 1px solid #1f1f23; min-height: 70vh; border-radius: 20px; padding: 12px; }
        .btn-aba { opacity: 0.5; transition: 0.3s; }
        .btn-aba.active { opacity: 1; color: #fbbf24; border-bottom: 2px solid #fbbf24; }
        @media print { body * { display: none !important; } #area-print { display: block !important; width: 72mm; color: black !important; background: white !important; font-family: monospace; font-size: 12px; padding: 10px; white-space: pre-wrap; } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-[#18181b] border-b border-gray-800 p-4 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-black italic text-red-600 tracking-tighter">KM<span class="text-white">PRO</span></h1>
            
            <button id="btn-status-loja" onclick="toggleLoja()" class="flex items-center gap-2 px-4 py-2 rounded-full font-bold text-xs uppercase transition-all shadow-lg hover:brightness-110">
                <div id="led-status" class="w-2 h-2 rounded-full bg-white"></div>
                <span id="texto-status">Carregando...</span>
            </button>
        </div>

        <nav class="flex gap-6">
            <button onclick="mudar('caixa')" id="b-caixa" class="btn-aba active text-sm font-bold uppercase">Caixa</button>
            <button onclick="mudar('cozinha')" id="b-cozinha" class="btn-aba text-sm font-bold uppercase">Cozinha</button>
            <button onclick="mudar('relatorio')" id="b-relatorio" class="btn-aba text-sm font-bold uppercase">Relat√≥rio</button>
        </nav>
    </header>

    <div id="aba-caixa" class="flex-1 flex overflow-hidden">
        <div class="flex-1 flex flex-col p-6 overflow-hidden">
            <div id="pdv-menu" class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-4 gap-3 pr-2 content-start"></div>
        </div>
        <div class="w-80 bg-[#18181b] border-l border-gray-800 p-6 flex flex-col shadow-2xl z-10">
            <h2 class="text-xs font-black text-gray-500 uppercase mb-4 tracking-widest">Pedido Balc√£o</h2>
            <div id="pdv-list" class="flex-1 overflow-y-auto text-sm space-y-2 mb-4 border-b border-gray-800 pb-4"></div>
            <div class="flex justify-between text-xl font-black text-white mb-4"><span>TOTAL:</span><span id="pdv-total">R$ 0,00</span></div>
            <input type="text" id="pdv-nome" placeholder="Nome Cliente" class="w-full bg-[#121212] border border-gray-700 rounded-xl p-3 text-sm text-white mb-3 outline-none">
            <button onclick="lancarPDV()" class="w-full bg-red-600 text-white font-black py-4 rounded-xl text-sm uppercase shadow-lg hover:bg-red-500 transition">Lan√ßar</button>
        </div>
    </div>

    <div id="aba-cozinha" class="hidden flex-1 p-6 overflow-y-auto">
        <div class="grid grid-cols-3 gap-6">
            <div><h3 class="text-center text-[10px] font-black text-orange-500 uppercase mb-4 tracking-widest">Novos</h3><div id="col-novos" class="column-bg space-y-3"></div></div>
            <div><h3 class="text-center text-[10px] font-black text-blue-500 uppercase mb-4 tracking-widest">Preparo</h3><div id="col-preparando" class="column-bg space-y-3"></div></div>
            <div><h3 class="text-center text-[10px] font-black text-green-500 uppercase mb-4 tracking-widest">Prontos</h3><div id="col-finalizados" class="column-bg space-y-3 opacity-50"></div></div>
        </div>
    </div>

    <div id="aba-relatorio" class="hidden flex-1 p-10 overflow-y-auto">
        <div class="max-w-2xl mx-auto bg-[#18181b] p-8 rounded-3xl border border-gray-800">
            <h2 class="text-xl font-black text-white mb-6">Fechamento</h2>
            <div class="flex gap-4 mb-8">
                <input type="date" id="rel-data" class="bg-[#121212] border border-gray-700 text-white rounded-xl p-3 w-full outline-none">
                <button onclick="gerarRel()" class="bg-blue-600 px-6 rounded-xl font-bold uppercase text-xs">Buscar</button>
            </div>
            <div id="rel-resultado" class="text-gray-400 text-sm text-center">Selecione uma data.</div>
        </div>
    </div>

    <pre id="area-print" class="hidden"></pre>

    <script>
        const firebaseConfig = { databaseURL: "https://km-burguer-default-rtdb.firebaseio.com", projectId: "km-burguer" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const som = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // Card√°pio Simplificado para o PDV (Adicione os itens completos se quiser, igual ao do cliente)
        const cardapio = [
            {n:"X-Burguer",p:19.90}, {n:"X-Salada",p:22.90}, {n:"X-Bacon",p:27.90},
            {n:"KM-Simples",p:29.90}, {n:"KM-MAX",p:49.90}, {n:"Batata G",p:26.90},
            {n:"Coca Lata",p:7.90}, {n:"A√ßa√≠ 500ml",p:20.90}
        ];

        let pdvCart = []; let pdvTotal = 0; let lojaAberta = true;

        // CONTROLE LOJA
        db.ref('config/loja_aberta').on('value', snap => {
            lojaAberta = snap.val();
            const btn = document.getElementById('btn-status-loja');
            const led = document.getElementById('led-status');
            const txt = document.getElementById('texto-status');

            if (lojaAberta === false) {
                btn.className = "flex items-center gap-2 px-6 py-3 rounded-full font-bold text-xs uppercase transition-all shadow-lg bg-red-900/20 border border-red-900 text-red-500 hover:bg-red-900/40";
                led.className = "w-2 h-2 rounded-full bg-red-500";
                txt.innerText = "LOJA FECHADA üî¥";
            } else {
                btn.className = "flex items-center gap-2 px-6 py-3 rounded-full font-bold text-xs uppercase transition-all shadow-lg bg-green-900/20 border border-green-900 text-green-500 hover:bg-green-900/40";
                led.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                txt.innerText = "LOJA ABERTA üü¢";
            }
        });

        function toggleLoja() {
            // Se estiver null (primeira vez), considera aberta, ent√£o vamos fechar
            const novoStatus = !lojaAberta;
            db.ref('config/loja_aberta').set(novoStatus);
        }

        // PDV
        function renderPDV() {
            document.getElementById('pdv-menu').innerHTML = cardapio.map(i => `
                <button onclick="addPDV('${i.n}',${i.p})" class="bg-[#1e1e24] border border-gray-800 p-4 rounded-xl text-left hover:border-red-600 transition group">
                    <div class="font-bold text-gray-200 text-xs mb-1 group-hover:text-white">${i.n}</div>
                    <div class="font-black text-red-500">R$ ${i.p.toFixed(2)}</div>
                </button>`).join('');
        }
        function addPDV(n,p) { pdvCart.push({n,p}); pdvTotal+=p; updatePDV(); }
        function updatePDV() { document.getElementById('pdv-list').innerHTML = pdvCart.map(i=>`<div class="flex justify-between border-b border-gray-800 py-1 text-gray-400"><span>${i.n}</span><span>${i.p.toFixed(2)}</span></div>`).join(''); document.getElementById('pdv-total').innerText=`R$ ${pdvTotal.toFixed(2)}`; }
        function lancarPDV() {
            const n = document.getElementById('pdv-nome').value;
            if(!n || !pdvCart.length) return alert("Erro");
            db.ref('pedidos').push().set({
                cliente: n + " (BALC√ÉO)", itens: pdvCart.map(i=>i.n).join(', '), total: pdvTotal,
                status: 'novos', hora: new Date().toLocaleTimeString('pt-BR'), data: new Date().toISOString().split('T')[0], endereco: 'BALC√ÉO', pagamento: 'CAIXA'
            });
            pdvCart=[]; pdvTotal=0; document.getElementById('pdv-nome').value=''; updatePDV();
        }

        // COZINHA (Igual ao anterior)
        db.ref('pedidos').on('value', snap => {
            const data = snap.val(); const hoje = new Date().toISOString().split('T')[0];
            const cols = { novos: '', preparando: '', finalizados: '' };
            for(let id in data) {
                const p = data[id];
                const card = `<div class="bg-[#1e1e24] p-4 rounded-xl border-l-4 ${p.status==='novos'?'border-orange-500':'border-blue-500'} mb-3"><div class="flex justify-between mb-2"><span class="font-bold text-white text-xs">${p.cliente}</span><span class="text-[10px] text-gray-500">${p.hora}</span></div><p class="text-[10px] text-gray-400 mb-2">${p.itens}</p><div class="flex justify-between pt-2 border-t border-gray-800"><span class="font-bold text-green-500 text-xs">R$ ${p.total.toFixed(2)}</span><div class="flex gap-2"><button onclick="imp('${id}')" class="bg-gray-800 p-1 rounded">üñ®Ô∏è</button>${p.status==='novos'?`<button onclick="up('${id}','preparando')" class="bg-blue-600 px-2 py-1 rounded text-[10px] font-bold">Fazer</button>`:''}${p.status==='preparando'?`<button onclick="up('${id}','finalizados')" class="bg-green-600 px-2 py-1 rounded text-[10px] font-bold">Fim</button>`:''}</div></div></div>`;
                if(p.status!=='finalizados' || p.data===hoje) cols[p.status]+=card;
            }
            document.getElementById('col-novos').innerHTML=cols.novos; document.getElementById('col-preparando').innerHTML=cols.preparando; document.getElementById('col-finalizados').innerHTML=cols.finalizados;
        });
        db.ref('pedidos').on('child_added', s=>{ if(s.val().status==='novos') som.play().catch(()=>{}); });
        function up(id,s){ db.ref('pedidos/'+id).update({status:s}); }
        function imp(id){ db.ref('pedidos/'+id).once('value',s=>{ const p=s.val(); document.getElementById('area-print').innerText=`KM BURGER\nID:#${id.slice(-4)}\n${p.cliente}\nITENS:\n${p.itens}\nTOTAL: R$${p.total.toFixed(2)}\nENTREGA: ${p.endereco}\nTAXA: R$${(p.taxa||0).toFixed(2)}\n.`; window.print(); }); }

        // NAVEGA√á√ÉO
        function mudar(aba) {
            ['caixa','cozinha','relatorio'].forEach(id => {
                document.getElementById('aba-'+id).classList.add('hidden');
                document.getElementById('b-'+id).classList.remove('active');
            });
            document.getElementById('aba-'+aba).classList.remove('hidden');
            document.getElementById('b-'+aba).classList.add('active');
        }

        // RELATORIO
        function gerarRel() {
            const d = document.getElementById('rel-data').value;
            db.ref('pedidos').once('value', s => {
                const data = s.val(); let t = 0; let l = '';
                for(let id in data) { const p = data[id]; if(p.data === d && p.status === 'finalizados') { t += p.total; l += `<div class="flex justify-between border-b border-gray-800 py-2 text-xs text-gray-400"><span>${p.hora} - ${p.cliente}</span><span>${p.total.toFixed(2)}</span></div>`; } }
                document.getElementById('rel-resultado').innerHTML = t>0 ? `<div class="text-center text-green-500 font-bold text-2xl mb-4">TOTAL: R$ ${t.toFixed(2)}</div>${l}` : 'Sem vendas.';
            });
        }

        renderPDV(); mudar('caixa');
    </script>
</body>
</html>
